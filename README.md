# Sensor Fusion by Extended Kalman Filter
## Video Demo
For both videos, please watch them at the highest res on Youtube.

See the demo with Odometry, imu and landmark detections [here](https://youtu.be/6gxRd_A1yz0).

See the demo only with Odometry and imu [here](https://youtu.be/yEdiKWycDxo).

### Rviz Visualization Explainations
<p align = "center">
  <img src = "files/rviz.png">
</p>

* The top left image is the raw image received from camera
* The top right image is the image with apriltag detection result
* The white line denotes the true path of the robot
* The red line denotes the path generated only by motion model prediction
* The green line denotes the path estimated by EKF
* The frame axis marker with color (top right) denotes the configuration of currently detected tag

<p align="center">
  <b>Fig 1. Rviz Visualization</b><br>
</p>



## Set Up
* Ubuntu 18.04
* ROS-melodic
* Turtlebot3-burger
* Raspberry Pi RGB Camera (with res at 320 x 240)

## Dependency
* [apriltag_ros](http://wiki.ros.org/apriltag_ros)
* Gazebo Camera Plugin
* Gazebo Imu Plugin
* [rqt_multiplot](https://github.com/ANYbotics/rqt_multiplot_plugin) (optional)
* [Eigen3](https://eigen.tuxfamily.org/dox/GettingStarted.html)

## Table of Contents
- [1. Project Objective](#Project-Objective)
- [2. Project Pipeline](#Project-Pipeline)
- [3. Experimental Results](#Experimental-Results)

## Project Objective
This project aims at implementing the Extended Kalman Filter (EKF) to track the robot state (which is (x, y, yaw)) in real time. The data from wheel encoder is used to predict the robot state in **motion model**. The **measurement model** utilizes the data from Apriltag landmark detection and the data from IMU sensor. The measurement of landmark is used to estimate the posterior from the prior generated by motion model. The measurement of yaw from IMU is used to further correctify the estimation of yaw.

Besides, since the data from all sensors are not synchronized, the time stamp of each sensor's measurement is recorded to guarantee a correct logic in each filter update.

## Project Pipeline

<p align = "center">
  <img src = "files/hmm.png" height = "240px">
</p>
<p align="center">
  <b>Fig 2. Hidden Markov Model </b><br>
</p>

As is known, the underlying model behind Kalman Filters is Hidden Markov Model. However, since in this project we have multiple unsynchronized sensor measurements, we need to do some tricks on state update rules. A customized pipeline is shown as below:

<p align = "center">
  <img src = "files/pipeline.png" height = "600px">
</p>
<p align="center">
  <b>Fig 3. Project Pipeline </b><br>
</p>

### Motion Model and Measurement Models
Since this project is implemented in an ideal environment, the raw odometry is extremely accurate. For easy implementation and visualization, we consider the raw odometry as the gound truth.

**Sample motion model odometry** (from Probabilistic Robotics P110) is used for motion model prediction. The difference (dx, dy, dyaw) between two raw odometry measurements is used to generate the required (rot1, translation, rot2) data with some extra manually added noise.

IMU and landmark detections measure the yaw angle and (x, y, yaw) respectively. Since they measure the state directly, they are considered as linear measurement models.

### Experimental Results
The error of Euclidean distance (in meters) and the error of yaw (in radius) between estimated odometry and the true odometry are plotted in real time by using rqt_multiplot. For comparison, those errors between the odometry only updated by the motion model and the true odometry are also presented.

#### Fuse Odometry, IMU and Landmark detections
<p align = "center">
  <img src = "files/landmark_imu_xy.png" height = "600px">
</p>
<p align="center">
  <b>Fig 4(a). Euclidean distance error </b><br>
</p>

<p align = "center">
  <img src = "files/landmark_imu_yaw.png" height = "600px">
</p>
<p align="center">
  <b>Fig 4(b). Yaw angle error </b><br>
</p>

#### Fuse Odometry and IMU
<p align = "center">
  <img src = "files/imu_xy.png" height = "600px">
</p>
<p align="center">
  <b>Fig 5(a). Euclidean distance error </b><br>
</p>

<p align = "center">
  <img src = "files/imu_yaw.png" height = "600px">
</p>
<p align="center">
  <b>Fig 5(b). Yaw angle error </b><br>
</p>
